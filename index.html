<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Immune Quest</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace;overflow:hidden}
canvas{display:block;margin:auto;image-rendering:pixelated}
#ui{position:fixed;inset:0;pointer-events:none}
#hearts{position:absolute;top:8px;left:8px}
#quest{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
width:92%;background:rgba(0,0,0,.85);border:2px solid #555;padding:8px}
#info{position:absolute;top:8px;right:8px;width:260px;
background:rgba(0,0,0,.85);border:2px solid #555;padding:8px;white-space:pre-line}
#fade{
position:fixed;inset:0;background:#000;pointer-events:none;
opacity:0;transition:opacity 1s
}
</style>
</head>
<body>

<canvas id="game" width="960" height="540"></canvas>
<div id="fade"></div>

<div id="ui">
  <div id="hearts"></div>
  <div id="info"></div>
  <div id="quest"></div>
</div>

<script>
const c=document.getElementById("game"),ctx=c.getContext("2d");
const fade=document.getElementById("fade");

const keys={},mouse={x:0,y:0,down:false};
document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
c.addEventListener("mousemove",e=>{
 let r=c.getBoundingClientRect();
 mouse.x=e.clientX-r.left;
 mouse.y=e.clientY-r.top;
});
c.addEventListener("mousedown",()=>mouse.down=true);
c.addEventListener("mouseup",()=>mouse.down=false);

/* GAME STATE */
let cutscene=true;
let cutsceneText="You are an immune cell.\nThe body is under attack.\nDefend it.";
let cutTimer=0;
let screenShake=0;

/* PLAYER */
const p={
 x:480,y:270,
 hearts:5,
 speed:2.6,
 dmg:10,
 fireDelay:14,
 cd:0
};

let bullets=[],enemies=[],zone=0;

/* ZONES (ORGAN COLORS & TEXTURES) */
const zones=[
{name:"Lungs",color:"#223b44",texture:"lungs",
 npc:"Lungs",quest:"Help me breathe!"},
{name:"Stomach",color:"#5b3b2e",texture:"stomach",
 npc:"Stomach",quest:"Destroy the virus!"},
{name:"Brain",color:"#2a2a2a",texture:"brain",
 npc:"Brain",quest:"Protect neural pathways!"},
{name:"Bloodstream",color:"#4b1111",texture:"blood",
 npc:"Blood",quest:"Stop the infection!"},
{name:"Immune Core",color:"#000",texture:"core",
 npc:"Immune Core",quest:"FINAL THREAT!",boss:true}
];

/* SPAWN */
function spawn(){
 enemies=[];
 for(let i=0;i<(zones[zone].boss?1:6);i++){
  enemies.push({
   x:Math.random()*960,
   y:Math.random()*540,
   hp:zones[zone].boss?250:40,
   max:zones[zone].boss?250:40,
   r:zones[zone].boss?32:16,
   sp:zones[zone].boss?1.2:1.6
  });
 }
}

/* CUTSCENE */
function startCutscene(text){
 cutscene=true;
 cutsceneText=text;
 cutTimer=0;
 fade.style.opacity=1;
 setTimeout(()=>fade.style.opacity=0,800);
}

/* UPDATE */
function update(){
 if(cutscene){
  cutTimer++;
  if(cutTimer>180){
   cutscene=false;
   spawn();
  }
  return;
 }

 let dx=0,dy=0;
 if(keys.w||keys.arrowup)dy--;
 if(keys.s||keys.arrowdown)dy++;
 if(keys.a||keys.arrowleft)dx--;
 if(keys.d||keys.arrowright)dx++;
 let l=Math.hypot(dx,dy)||1;
 p.x+=dx/l*p.speed;
 p.y+=dy/l*p.speed;

 if(mouse.down&&p.cd<=0){
  let a=Math.atan2(mouse.y-p.y,mouse.x-p.x);
  bullets.push({x:p.x,y:p.y,vx:Math.cos(a)*7,vy:Math.sin(a)*7});
  p.cd=p.fireDelay;
 }
 p.cd--;

 bullets.forEach(b=>{b.x+=b.vx;b.y+=b.vy});
 bullets=bullets.filter(b=>b.x>0&&b.y>0&&b.x<960&&b.y<540);

 enemies.forEach(e=>{
  let a=Math.atan2(p.y-e.y,p.x-e.x);
  e.x+=Math.cos(a)*e.sp;
  e.y+=Math.sin(a)*e.sp;
  if(Math.hypot(p.x-e.x,p.y-e.y)<e.r+10){
   p.hearts--;
   screenShake=10;
  }
 });

 bullets.forEach(b=>{
  enemies.forEach(e=>{
   if(Math.hypot(b.x-e.x,b.y-e.y)<e.r){
    e.hp-=p.dmg;
    b.dead=true;
   }
  });
 });

 bullets=bullets.filter(b=>!b.dead);
 enemies=enemies.filter(e=>e.hp>0);

 if(enemies.length===0){
  zone++;
  if(zone<zones.length){
   startCutscene("Entering "+zones[zone].name+"...");
  }
 }
}

/* DRAW BACKGROUND */
function drawBackground(z){
 ctx.fillStyle=z.color;
 ctx.fillRect(0,0,960,540);

 // organic blobs
 ctx.fillStyle="rgba(255,255,255,0.05)";
 for(let i=0;i<60;i++){
  ctx.beginPath();
  ctx.arc(Math.random()*960,Math.random()*540,
  20+Math.random()*40,0,Math.PI*2);
  ctx.fill();
 }
}

/* DRAW */
function draw(){
 let ox=screenShake?Math.random()*screenShake-screenShake/2:0;
 let oy=screenShake?Math.random()*screenShake-screenShake/2:0;
 screenShake=Math.max(0,screenShake-1);
 ctx.setTransform(1,0,0,1,ox,oy);

 let z=zones[Math.min(zone,zones.length-1)];
 drawBackground(z);

 // player (immune cell)
 ctx.fillStyle="#ff7777";
 ctx.beginPath();
 ctx.arc(p.x,p.y,10,0,Math.PI*2);
 ctx.fill();
 ctx.fillStyle="#fff";
 ctx.fillRect(p.x-2,p.y-2,4,4);

 // bullets
 ctx.fillStyle="#ffaaaa";
 bullets.forEach(b=>{
  ctx.beginPath();
  ctx.arc(b.x,b.y,3,0,Math.PI*2);
  ctx.fill();
 });

 // enemies
 enemies.forEach(e=>{
  ctx.fillStyle="#66ff66";
  ctx.beginPath();
  ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
  ctx.fill();

  ctx.fillStyle="#000";
  ctx.fillRect(e.x-20,e.y-e.r-10,40,4);
  ctx.fillStyle="#f44";
  ctx.fillRect(e.x-20,e.y-e.r-10,40*(e.hp/e.max),4);
 });

 // crosshair
 ctx.strokeStyle=mouse.down?"#f55":"#fff";
 ctx.beginPath();
 ctx.moveTo(mouse.x-8,mouse.y);
 ctx.lineTo(mouse.x+8,mouse.y);
 ctx.moveTo(mouse.x,mouse.y-8);
 ctx.lineTo(mouse.x,mouse.y+8);
 ctx.stroke();

 document.getElementById("hearts").textContent="Health: "+"â™¥ ".repeat(p.hearts);
 document.getElementById("quest").textContent=z.npc+": "+z.quest;
 document.getElementById("info").textContent="Zone: "+z.name;
}

/* LOOP */
function loop(){
 if(p.hearts<=0){
  ctx.fillStyle="#fff";
  ctx.font="30px monospace";
  ctx.fillText("IMMUNE SYSTEM FAILED",280,270);
  return;
 }
 if(zone>=zones.length){
  ctx.fillStyle="#fff";
  ctx.font="30px monospace";
  ctx.fillText("BODY SAVED",380,270);
  return;
 }
 update();
 draw();
 requestAnimationFrame(loop);
}

startCutscene(cutsceneText);
loop();
</script>
</body>
</html>
